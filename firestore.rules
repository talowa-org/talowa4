rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user owns the document
    function isOwn(uid) {
      return request.auth != null && request.auth.uid == uid;
    }

    // Fields that clients must NEVER write
    function hasServerOnlyChanges(newData, oldData) {
      return newData.diff(oldData).changedKeys().hasAny([
        'referralCode','referredBy','referralChain',
        'directReferralCount','totalTeamSize',
        'status','membershipPaid','paidAt','paymentRef',
        'provisionalRef','assignedBySystem','role'
      ]);
    }

    // Allowed keys the app updates at login/registration
    function allowedClientKeys(newData, oldData) {
      return newData.diff(oldData).changedKeys().hasOnly([
        'fullName','email','emailAlias','phone',
        'language','locale','bio','address',
        'profileCompleted','phoneVerified',
        'lastLoginAt','device'
      ]);
    }

    // Validate lastLoginAt and device payloads
    function isLoginPatchValid(newData) {
      return
        (!newData.keys().hasAny(['lastLoginAt']) || request.time == newData.lastLoginAt) &&
        (!newData.keys().hasAny(['device']) ||
          (newData.device is map &&
           newData.device.keys().hasOnly(['platform','appVersion']) &&
           newData.device.platform is string &&
           newData.device.appVersion is string));
    }

    // Validate registration data structure
    function isValidRegistrationData(data) {
      return data.keys().hasOnly([
        'fullName','email','emailAlias','phone',
        'language','locale','address',
        'profileCompleted','phoneVerified',
        'lastLoginAt','device'
      ]) &&
      data.profileCompleted == true &&
      data.phoneVerified == true;
    }

    // Users collection - strict security rules for referral system
    match /users/{userId} {
      // Allow read access to own profile and basic info of others
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        isPublicUserData()
      );

      // Allow create only for own profile during registration with tight constraints
      allow create: if isOwn(userId) &&
                    !hasServerOnlyChanges(request.resource.data, {}) &&
                    isValidRegistrationData(request.resource.data) &&
                    isLoginPatchValid(request.resource.data);

      // Allow update only for specific safe fields and own profile
      allow update: if isOwn(userId) &&
                    !hasServerOnlyChanges(request.resource.data, resource.data) &&
                    allowedClientKeys(request.resource.data, resource.data) &&
                    isLoginPatchValid(request.resource.data);

      // No delete allowed for users
      allow delete: if false;

      // Helper functions for user validation
      function isPublicUserData() {
        return request.query.limit <= 100 && (
          'fullName' in resource.data ||
          'role' in resource.data ||
          'referralCode' in resource.data
        );
      }
    }
    
    // User registry for quick lookups - MUST allow unauthenticated read for login check
    match /user_registry/{phoneNumber} {
      allow read: if true; // Allow unauthenticated read for login verification
      allow write: if request.auth != null && request.auth.uid == request.resource.data.uid;
      allow create: if request.auth != null;
    }
    
    // Land records - users can manage their own records
    match /land_records/{recordId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.ownerId;
      allow read: if request.auth != null && 
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['village_coordinator', 'mandal_coordinator', 'district_coordinator']);
    }
    
    // Legal cases - users can manage their own cases
    match /legal_cases/{caseId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.clientId;
      allow read: if request.auth != null && 
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['village_coordinator', 'mandal_coordinator', 'district_coordinator']);
    }
    
    // Emergency incidents - users can create and read relevant incidents
    match /emergency_incidents/{incidentId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null;
      allow update: if request.auth != null && 
        (request.auth.uid == resource.data.reporterId || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['village_coordinator', 'mandal_coordinator', 'district_coordinator']);
    }
    
    // Emergency broadcasts - only coordinators can create
    match /emergency_broadcasts/{broadcastId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['village_coordinator', 'mandal_coordinator', 'district_coordinator', 'state_coordinator'];
    }
    
    // Emergency contacts - read-only for users
    match /emergency_contacts/{contactId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['district_coordinator', 'state_coordinator', 'national_leadership'];
    }
    
    // Lawyers directory - read-only for users
    match /lawyers/{lawyerId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['district_coordinator', 'state_coordinator', 'national_leadership'];
    }
    
    // Feed posts - users can read all, coordinators can write
    match /feed_posts/{postId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['village_coordinator', 'mandal_coordinator', 'district_coordinator', 'state_coordinator'];
    }
    
    // Messages and conversations
    match /conversations/{conversationId} {
      allow read, write: if request.auth != null && 
        request.auth.uid in resource.data.participantIds;
    }
    
    match /messages/{messageId} {
      allow read, write: if request.auth != null;
    }
    
    // Posts collection - social feed posts
    match /posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.authorId;
      allow update: if request.auth != null;
      allow delete: if request.auth != null && request.auth.uid == resource.data.authorId;
    }
    
    // Post likes
    match /post_likes/{likeId} {
      allow read, write: if request.auth != null;
    }
    
    // Post comments
    match /post_comments/{commentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.authorId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.authorId;
    }
    
    // Stories collection - 24-hour temporary content
    match /stories/{storyId} {
      allow read: if request.auth != null && 
        resource.data.isActive == true && 
        resource.data.expiresAt > request.time;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.authorId;
      allow update: if request.auth != null && (
        request.auth.uid == resource.data.authorId ||
        // Allow any authenticated user to update view counts and reactions
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views', 'reactions']))
      );
      allow delete: if request.auth != null && request.auth.uid == resource.data.authorId;
    }
    
    // Story views
    match /story_views/{viewId} {
      allow read, write: if request.auth != null;
    }
    
    // AI interactions - users can create their own
    match /ai_interactions/{interactionId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Content collection - daily motivation and other content
    match /content/{contentId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['district_coordinator', 'state_coordinator', 'national_leadership'];
      allow create: if request.auth != null;
    }
    
    // Daily motivation collection
    match /daily_motivation/{motivationId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
    }
    
    // Active stories collection
    match /active_stories/{storyId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
    }

    // Drafts collection - users can manage their own drafts
    match /drafts/{draftId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.authorId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.authorId;
    }

    // Analytics collection - users can read their own analytics
    match /analytics/{analyticsId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow write: if request.auth != null;
    }

    // User analytics collection
    match /user_analytics/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null;
    }

    // Notifications collection - users can read their own notifications
    match /notifications/{notificationId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null;
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Hashtags collection - read access for all authenticated users
    match /hashtags/{hashtagId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Reports collection - for content moderation
    match /reports/{reportId} {
      allow read: if request.auth != null &&
        (request.auth.uid == resource.data.reportedBy ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['village_coordinator', 'mandal_coordinator', 'district_coordinator', 'state_coordinator']);
      allow create: if request.auth != null && request.auth.uid == request.resource.data.reportedBy;
      allow update: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['village_coordinator', 'mandal_coordinator', 'district_coordinator', 'state_coordinator'];
    }

    // Campaign collection - for movement campaigns
    match /campaigns/{campaignId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['village_coordinator', 'mandal_coordinator', 'district_coordinator', 'state_coordinator'];
    }

    // Geographic hierarchy collections
    match /states/{stateId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['state_coordinator', 'national_leadership'];
    }

    match /districts/{districtId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['district_coordinator', 'state_coordinator', 'national_leadership'];
    }

    match /mandals/{mandalId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['mandal_coordinator', 'district_coordinator', 'state_coordinator', 'national_leadership'];
    }

    match /villages/{villageId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['village_coordinator', 'mandal_coordinator', 'district_coordinator', 'state_coordinator', 'national_leadership'];
    }

    // Referral system collections - strict server-only access

    // Referral codes collection - read-only for clients
    match /referralCodes/{codeId} {
      // Allow read for validation purposes
      allow read: if request.auth != null;

      // No write access for clients - server only
      allow write: if false;
    }

    // Referrals collection - read-only for clients
    match /referrals/{referralId} {
      // Allow read for own referrals only
      allow read: if request.auth != null && (
        resource.data.referrerId == request.auth.uid ||
        resource.data.referredUserId == request.auth.uid
      );

      // No write access for clients - server only
      allow write: if false;
    }

    // Payments collection - read-only for own payments
    match /payments/{paymentId} {
      // Allow read for own payments only
      allow read: if request.auth != null &&
        resource.data.userId == request.auth.uid;

      // No write access for clients - server only
      allow write: if false;
    }

    // Commissions collection - read-only for own commissions
    match /commissions/{commissionId} {
      // Allow read for own commissions only
      allow read: if request.auth != null &&
        resource.data.userId == request.auth.uid;

      // No write access for clients - server only
      allow write: if false;
    }

    // Performance metrics - no client access
    match /performance_metrics/{metricId} {
      allow read, write: if false;
    }

    // Error events - no client access
    match /error_events/{errorId} {
      allow read, write: if false;
    }

    // Critical alerts - no client access
    match /critical_alerts/{alertId} {
      allow read, write: if false;
    }

    // Analytics events - no client access
    match /analytics_events/{eventId} {
      allow read, write: if false;
    }

    // Achievements collection - read-only for own achievements
    match /achievements/{achievementId} {
      // Allow read for own achievements
      allow read: if request.auth != null &&
        resource.data.userId == request.auth.uid;

      // No write access for clients - server only
      allow write: if false;
    }

    // Certificates collection - read-only for own certificates
    match /certificates/{certificateId} {
      // Allow read for own certificates
      allow read: if request.auth != null &&
        resource.data.userId == request.auth.uid;

      // No write access for clients - server only
      allow write: if false;
    }


  }
}