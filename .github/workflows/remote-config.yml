name: Remote Config Publish

on:
  workflow_dispatch:
  push:
    paths:
      - 'remoteconfig/rc.template.json'
      - '.github/workflows/remote-config.yml'

jobs:
  publish-remote-config:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          token_format: 'access_token'

      - name: Publish Remote Config via REST (non-ETag)
        id: publish
        env:
          ACCESS_TOKEN: ${{ steps.auth.outputs.access_token }}
          PROJECT_ID: talowa
        run: |
          set -euo pipefail
          echo "Publishing Remote Config to project: $PROJECT_ID"

          # 1) GET current template to read its ETag
          curl -sS -X GET \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Accept: application/json" \
            "https://firebaseremoteconfig.googleapis.com/v1/projects/$PROJECT_ID/remoteConfig" \
            -D /tmp/get_headers.txt -o /tmp/get_body.json

          echo "GET headers:" && head -n 25 /tmp/get_headers.txt || true
          echo "GET body (first 30 lines):" && head -n 30 /tmp/get_body.json || true

          etag=$(grep -i '^etag:' /tmp/get_headers.txt | awk '{print $2}' | tr -d '\r' || true)
          if [[ -z "${etag:-}" ]]; then
            # Some responses include ETag only in the body
            etag=$(grep -o '"etag"[^"]*"[^"]*"' /tmp/get_body.json | sed 's/.*"etag"[^"]*"\([^"]*\)".*/\1/' || true)
          fi
          if [[ -z "${etag:-}" ]]; then
            echo "Warning: ETag not found; proceeding with If-Match: * (non-ETag mode)." >&2
            etag="*"
          fi
          echo "Using ETag: $etag"
          echo "etag=$etag" >> "$GITHUB_OUTPUT"

          # PUT new template (will use If-Match: * in non-ETag mode)
          http_code=$(curl -sS -w "%{http_code}" -X PUT \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json; charset=UTF-8" \
            -H "If-Match: $etag" \
            --data-binary @remoteconfig/rc.template.json \
            "https://firebaseremoteconfig.googleapis.com/v1/projects/$PROJECT_ID/remoteConfig" \
            -D /tmp/headers.txt -o /tmp/body.json)

          echo "Response headers:" && head -n 25 /tmp/headers.txt || true
          echo "Response body (first 100 lines):" && head -n 100 /tmp/body.json || true
          echo "HTTP status: $http_code"
          echo "http_status=$http_code" >> "$GITHUB_OUTPUT"

          # Consider any 2xx status a success, and warn if ETag is missing
          if [[ "$http_code" -ge 200 && "$http_code" -lt 300 ]]; then
            if grep -qi "etag:" /tmp/headers.txt || grep -qi '"etag"' /tmp/body.json; then
              echo "Remote Config publish completed (ETag present)."
            else
              echo "Remote Config publish completed, but ETag not found in headers/body." >&2
            fi
          else
            echo "Remote Config publish failed with HTTP $http_code; see logs above." >&2
            exit 1
          fi

          # Additional failure check: if response body contains a top-level error object, fail the job
          if grep -q '"error"[[:space:]]*{' /tmp/body.json; then
            echo "API returned an error object, failing the job." >&2
            cat /tmp/body.json >&2 || true
            exit 1
          fi


          # 3) Save artifacts for troubleshooting
          echo "$etag" > /tmp/etag.txt

      - name: Upload response artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: remote-config-response
          path: |
            /tmp/headers.txt
            /tmp/body.json
            /tmp/get_headers.txt
            /tmp/get_body.json
            /tmp/etag.txt

      - name: Job summary
        run: |
          {
            echo "### Remote Config Publish"
            echo
            echo "- HTTP status: ${{ steps.publish.outputs.http_status }}"
            echo "- ETag: ${{ steps.publish.outputs.etag }}"
          } >> "$GITHUB_STEP_SUMMARY"


      - name: Comment summary on commit
        if: github.event_name == 'push'
        uses: peter-evans/commit-comment@v3
        with:
          body: |
            Remote Config publish completed.
            - HTTP status: ${{ steps.publish.outputs.http_status }}
            - ETag: ${{ steps.publish.outputs.etag }}
